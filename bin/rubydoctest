#!/usr/bin/env ruby

options, files = ARGV.partition{ |a| a =~ /^-/ }

if ARGV.empty? or options.include?("-h") or options.include?("--help")
  puts <<-DIRECTIONS
Ruby DocTest
USAGE: rubydoctest [options] <files>
  
  rubydoctest parses Ruby files (.rb) or DocTest files (.doctest) for irb-style
  sessions in comments, and runs the commented sessions as tests.
  
  Options:
    General:
      --help   - show this usage / help information
      --single - run all tests in the same ruby environment
      -t<n>    - only run test number n, e.g. -t1 -t3
    
    Output Format:
      --html  - output in HTML format
      --plain - force output in plain text (no Ansi colors) [windows default]
    
    Debug:
      --ignore-interactive - do not heed !!! special directives
      --trace     - turn backtrace on to debug Ruby DocTest
      --debugger  - include ruby-debug library / gem
      --verbose   - print more (useful only with --plain)
      --require=</path/to/require>,</another/path/to/require> - eg. --require=config/environment.rb
  
  See http://github.com/tablatom/rubydoctest/wikis for more information.
  DIRECTIONS
  exit 0
end

single = options.include?('--single')

requires = ['doctest']
requires << 'ruby-debug' if options.include?('--debugger')

if options.detect {|opt| opt =~ /^--require=(.+)/}
  requires << $1.split(',')
end

ruby_lines = []
ruby_lines << 'DocTest::Configuration.trace = true;' if options.include?('--trace')
ruby_lines << 'DocTest::Configuration.verbose = true;' if options.include?('--verbose') or options.include?('-v')
ruby_lines << 'DocTest::Configuration.ignore_interactive = true;' if options.include?('--ignore-interactive')

tests = options.map{ |o| o =~ /^-t(\d+)/; $1 }.compact
ruby_lines << "DocTest::Configuration.tests = #{tests.inspect};" if tests.size > 0

requires = requires.map {|lib| "require '#{lib}'; "}.join

def files_runner(command, files, requires, lines, single)
  preamble = <<END_CMD
#{requires} #{lines.join(' ')}

module Kernel
  # IRB redefines exit
  alias_method :our_exit, :exit
end

END_CMD
  if single
    cmd = preamble + 'our_exit('
    cmd << files.reverse.map do |f|
      %(DocTest::Runner.new(File.read('#{f}'), '#{f}').run )
    end.join('&& ')
    cmd << '? 0 : 1)'
    if ! system(%(#{command} -e "#{cmd}"))
      exit(1)
    end
  else
    files.reverse.detect do |f|
      binding.pry
      cmd = preamble + <<END_CMD2
our_exit(DocTest::Runner.new(File.read('#{f}'), '#{f}').run ? 0 : 1)
END_CMD2

      if ! system(%(#{command} -e "#{cmd}"))
        exit(1)
      end
    end
  end
end

if options.include?('--plain') or RUBY_PLATFORM =~ /mswin|mingw/
  ruby_lines << 'DocTest.output_format = :plain;'
  files_runner(RUBY_ENGINE, files, requires, ruby_lines, single)
elsif options.include?('--html')
  ruby_lines << 'DocTest.output_format = :html;'
  puts '<html><body><pre>'
  files_runner(RUBY_ENGINE, files, requires, ruby_lines, single)
  puts '</pre></body></html>'
else
  files_runner(RUBY_ENGINE, files, requires, ruby_lines, single)
end

exit(0)
